name: Explore Contexts
on:
  push:
    branches: [dev, main]

  pull_request:
    types: [opened, synchronize, reopened, edited, closed]
    branches:
      - dev
      - main

  create:
    # New tag or branch is created

  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd
        default: dev

      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan

permissions:
  contents: read
  id-token: write
  pull-requests: read

jobs:
  kickoff-dev-job:
    if: github.ref_name == 'dev' || github.base_ref == 'dev'
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: Write vars context to log
        env:
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: |-
          echo -e "\n\n==================== VARS CONTEXT ====================\n\n"
          echo "$VARS_CONTEXT"

  dev-job:
    if: github.ref_name == 'dev' || github.base_ref == 'dev'
    uses: ./.github/workflows/reusable_context_explorer.yaml
    with:
      environment: dev

  kickoff-stg-job:
    if: github.ref_name == 'main' || github.base_ref == 'main'
    environment: stg
    runs-on: ubuntu-latest
    steps:
      - name: Write vars context to log
        env:
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: |-
          echo -e "\n\n==================== VARS CONTEXT ====================\n\n"
          echo "$VARS_CONTEXT"

  stg-job:
    if: github.ref_name == 'main' || github.base_ref == 'main'
    uses: ./.github/workflows/reusable_context_explorer.yaml
    with:
      environment: stg

  kickoff-tag-job:
    if: startsWith(github.ref, 'refs/tags/')
    environment: prd
    runs-on: ubuntu-latest
    steps:
      - name: Write vars context to log
        env:
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: |-
          echo -e "\n\n==================== VARS CONTEXT ====================\n\n"
          echo "$VARS_CONTEXT"

  prd-job:
    if: startsWith(github.ref, 'refs/tags/')
    uses: ./.github/workflows/reusable_context_explorer.yaml
    with:
      environment: prd