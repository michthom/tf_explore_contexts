name: Explore Contexts
on:
  push:
    branches: [dev, main]

  pull_request:
    types: [opened, synchronize, reopened, edited, closed]
    branches:
      - dev
      - main

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd
        default: dev

      action:
        description: Action to perform
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan

permissions:
  contents: read
  id-token: write
  pull-requests: read

jobs:
  summary:
    environment: summary
    runs-on: ubuntu-latest
    steps:
      - name: Write summary of the github context to log
        run: |-
          echo -e "\n\n==================== GITHUB CONTEXT ====================\n\n"
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Type: ${{ github.ref_type }}"
          echo "Action: ${{ github.action }}"
          echo "Event Path: ${{ github.event_path }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Head Ref: ${{ github.head_ref }}"
        
  kickoff-dev-job:
    if: github.ref_name == 'dev' || github.base_ref == 'dev'
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: Write vars context to log
        env:
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: |-
          echo -e "\n\n==================== VARS CONTEXT ====================\n\n"
          echo "$VARS_CONTEXT"

  dev-job:
    if: github.ref_name == 'dev' || github.base_ref == 'dev'
    uses: ./.github/workflows/reusable_context_explorer.yaml
    with:
      environment: dev

  kickoff-stg-job:
    if: github.ref_name == 'main' || github.base_ref == 'main'
    environment: stg
    runs-on: ubuntu-latest
    steps:
      - name: Write vars context to log
        env:
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: |-
          echo -e "\n\n==================== VARS CONTEXT ====================\n\n"
          echo "$VARS_CONTEXT"

  stg-job:
    if: github.ref_name == 'main' || github.base_ref == 'main'
    uses: ./.github/workflows/reusable_context_explorer.yaml
    with:
      environment: stg

  kickoff-release-job:
    if: startsWith(github.ref, 'refs/tags/v_*')
    environment: prd
    runs-on: ubuntu-latest
    steps:
      - name: Write vars context to log
        env:
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: |-
          echo -e "\n\n==================== VARS CONTEXT ====================\n\n"
          echo "$VARS_CONTEXT"

  prd-job:
    if: startsWith(github.ref, 'refs/tags/v_*')
    uses: ./.github/workflows/reusable_context_explorer.yaml
    with:
      environment: prd